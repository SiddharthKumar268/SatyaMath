<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain E-Voting System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è SatyaMath E-Voting</h1>
            <p>Secure, Transparent, and Decentralized Voting on Ganache</p>
            
            <div id="networkIndicator" class="network-indicator hidden">
                üü¢ Ganache Local (Chain ID: 1337)
            </div>
        </div>

        <div class="card">
            <h2>üîå Connection</h2>
            <div id="connectionStatus" class="alert alert-warning">
                Not connected. Please connect MetaMask and load the contract.
            </div>
            
            <div class="form-group">
                <label>Contract Address:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="contractAddress" name="ca" autocomplete="off" style="flex: 1;" />
                    <button class="btn btn-secondary" onclick="copyContractAddress()" title="Copy Contract Address">
                        üìã Copy
                    </button>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="connectWallet()">Connect MetaMask</button>
            <button class="btn btn-success" onclick="loadContract()">Load Contract</button>
            
            <div class="status-bar hidden" id="statusBar">
                <div class="status-item">
                    <strong>Connected Account:</strong>
                    <span id="accountAddress">-</span>
                </div>
                <div class="status-item">
                    <strong>Current Phase:</strong>
                    <span id="currentPhase">-</span>
                </div>
                <div class="status-item">
                    <strong>Contract Address:</strong>
                    <span id="loadedContract">-</span>
                </div>
            </div>
        </div>

        <!-- SEMI-AUTOMATED VOTING SECTION -->
        <div class="card hidden" id="automationCard">
            <h2>ü§ñ Smart Automation Helper</h2>
            
            <div class="info-box">
                <strong>‚ú® How it works:</strong>
                This automation helps you conduct a complete voting demonstration:
                <br><br>
                <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                    <li>‚úì Adds 3 eligible voters automatically</li>
                    <li>‚úì Starts commit phase</li>
                    <li>‚úì YOU choose who each voter votes for</li>
                    <li>‚úì Automatically handles commit & reveal phases</li>
                    <li>‚úì Displays final results</li>
                </ul>
                <br>
                <strong>üó≥Ô∏è You have full control over the votes!</strong>
            </div>

            <!-- Vote Selection for Each Voter -->
            <div class="vote-selector">
                <h3 style="color: var(--primary); margin-bottom: 20px;">Choose Votes for Each Voter:</h3>
                
                <div style="margin-bottom: 15px;">
                    <label>üë© Voter 1 (Siddharth) votes for:</label>
                    <select id="voter1Choice" class="vote-choice">
                        <option value="0">Candidate A</option>
                        <option value="1">Candidate B</option>
                        <option value="2">Candidate C</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>üë® Voter 2 (Avi) votes for:</label>
                    <select id="voter2Choice" class="vote-choice">
                        <option value="0">Candidate A</option>
                        <option value="1" selected>Candidate B</option>
                        <option value="2">Candidate C</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label>üë¶ Voter 3 (Goli) votes for:</label>
                    <select id="voter3Choice" class="vote-choice">
                        <option value="0">Candidate A</option>
                        <option value="1">Candidate B</option>
                        <option value="2" selected>Candidate C</option>
                    </select>
                </div>
            </div>

            <!-- Vote Counter Stats -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="committedCount">0</div>
                    <div class="stat-label">Votes Committed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîì</div>
                    <div class="stat-value" id="revealedCount">0</div>
                    <div class="stat-label">Votes Revealed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="totalVotes">0</div>
                    <div class="stat-label">Total Votes Cast</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è±Ô∏è</div>
                    <div class="stat-value" id="phaseTimer">00:00</div>
                    <div class="stat-label">Time Elapsed</div>
                </div>
            </div>

            <button class="btn btn-success" onclick="runSmartAutomation()" id="automateBtn" style="width: 100%; font-size: 1.5em; padding: 20px; margin-top: 20px; font-weight: bold;">
                üéØ START VOTING WITH YOUR CHOICES
            </button>

            <div class="progress-container hidden" id="progressContainer">
                <h3 style="margin-bottom: 15px; color: var(--primary); font-weight: 700;">Automation Progress:</h3>
                <div class="progress-step" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">Adding voters & starting commit phase...</div>
                </div>
                <div class="progress-step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">Voters committing votes...</div>
                </div>
                <div class="progress-step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">Starting reveal phase...</div>
                </div>
                <div class="progress-step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-text">Voters revealing votes...</div>
                </div>
                <div class="progress-step" id="step5">
                    <div class="step-number">5</div>
                    <div class="step-text">‚úì Complete! Results below.</div>
                </div>
            </div>

            <div class="log-container hidden" id="logContainer"></div>
        </div>

        <!-- OWNER CONTROLS -->
        <div class="card hidden" id="ownerCard">
            <h2>üëë Owner Controls (Manual)</h2>
            
            <div class="owner-controls">
                <button class="btn btn-success" onclick="startCommitPhase()">Start Commit Phase</button>
                <button class="btn btn-info" onclick="startRevealPhase()">Start Reveal Phase</button>
                <button class="btn btn-danger" onclick="endVoting()">üèÅ End Voting</button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Add Eligible Voter Address:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="eligibleAddress" placeholder="0x..." style="flex: 1;" />
                    <button class="btn btn-warning" onclick="addEligibleVoter()">Add Eligible Voter</button>
                </div>
            </div>
        </div>

        <!-- Winner Banner -->
        <div class="winner-banner hidden" id="winnerBanner">
            <div class="winner-content">
                <div class="winner-icon">üèÜ</div>
                <div class="winner-text" id="winnerText"></div>
                <div class="winner-icon">üèÜ</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Voting Results & Analytics</h2>
            <button class="btn btn-info" onclick="refreshProposals()">üîÑ Refresh Results</button>
            
            <!-- Visual Bar Chart -->
            <div class="results-chart hidden" id="resultsChart">
                <h3 style="color: var(--primary); margin: 30px 0 20px 0; font-size: 1.5em;">Vote Distribution</h3>
                <div class="chart-container">
                    <div class="bar-chart" id="barChart"></div>
                </div>
            </div>
            
            <div class="proposals-grid" id="proposalsContainer">
                <p style="text-align: center; color: #666;">Load contract to see proposals...</p>
            </div>
        </div>

        <!-- Gas Analytics Card -->
        <div class="card hidden" id="gasAnalyticsCard">
            <h2>‚õΩ Gas Analytics & Transaction Costs</h2>
            <div class="gas-summary" id="gasSummary">
                <div class="gas-stat-card">
                    <div class="gas-stat-icon">üí∞</div>
                    <div class="gas-stat-value" id="totalGasCost">0.0000</div>
                    <div class="gas-stat-label">Total Gas Cost (ETH)</div>
                </div>
                <div class="gas-stat-card">
                    <div class="gas-stat-icon">‚ö°</div>
                    <div class="gas-stat-value" id="totalGasUsed">0</div>
                    <div class="gas-stat-label">Total Gas Used</div>
                </div>
                <div class="gas-stat-card">
                    <div class="gas-stat-icon">üìä</div>
                    <div class="gas-stat-value" id="avgGasPrice">0</div>
                    <div class="gas-stat-label">Avg Gas Price (Gwei)</div>
                </div>
                <div class="gas-stat-card">
                    <div class="gas-stat-icon">üî¢</div>
                    <div class="gas-stat-value" id="transactionCount">0</div>
                    <div class="gas-stat-label">Transactions</div>
                </div>
            </div>
            <div class="gas-log-container" id="gasLogContainer">
                <h3 style="color: var(--primary); margin-bottom: 15px;">üìã Detailed Gas Log</h3>
                <div class="gas-log-entries" id="gasLogEntries">
                    <p style="text-align: center; color: var(--gray-300); padding: 20px;">No transactions yet. Gas costs will appear here after voting starts.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üó≥Ô∏è Manual Voting (Advanced)</h2>
            
            <div class="info-box">
                <strong>‚ö†Ô∏è Advanced Users Only:</strong>
                Use the automation button above for easier voting! Manual voting allows you to vote one by one.
            </div>

            <div class="quick-vote-grid" id="quickVoteContainer">
                <div class="voter-card">
                    <div class="voter-avatar">üë©</div>
                    <h4>Siddharth (Voter 1)</h4>
                    <p class="voter-address">
                        0xFFcf...09f0
                        <button class="btn-icon" onclick="copyVoterAddress(1)" title="Copy Address">üìã</button>
                    </p>
                    
                    <div class="vote-selector" style="margin: 15px 0;">
                        <label>Choose Candidate:</label>
                        <select id="manualVoter1Choice" class="vote-choice">
                            <option value="0">Candidate A</option>
                            <option value="1">Candidate B</option>
                            <option value="2">Candidate C</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="manualCommitVote(1)">üîí Commit Vote</button>
                    <button class="btn btn-info" onclick="manualRevealVote(1)">üîì Reveal Vote</button>
                </div>

                <div class="voter-card">
                    <div class="voter-avatar">üë®</div>
                    <h4>Avi (Voter 2)</h4>
                    <p class="voter-address">
                        0x22d4...e32b
                        <button class="btn-icon" onclick="copyVoterAddress(2)" title="Copy Address">üìã</button>
                    </p>
                    
                    <div class="vote-selector" style="margin: 15px 0;">
                        <label>Choose Candidate:</label>
                        <select id="manualVoter2Choice" class="vote-choice">
                            <option value="0">Candidate A</option>
                            <option value="1">Candidate B</option>
                            <option value="2">Candidate C</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="manualCommitVote(2)">üîí Commit Vote</button>
                    <button class="btn btn-info" onclick="manualRevealVote(2)">üîì Reveal Vote</button>
                </div>

                <div class="voter-card">
                    <div class="voter-avatar">üë¶</div>
                    <h4>Goli (Voter 3)</h4>
                    <p class="voter-address">
                        0xE11B...882d
                        <button class="btn-icon" onclick="copyVoterAddress(3)" title="Copy Address">üìã</button>
                    </p>
                    
                    <div class="vote-selector" style="margin: 15px 0;">
                        <label>Choose Candidate:</label>
                        <select id="manualVoter3Choice" class="vote-choice">
                            <option value="0">Candidate A</option>
                            <option value="1">Candidate B</option>
                            <option value="2">Candidate C</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-success" onclick="manualCommitVote(3)">üîí Commit Vote</button>
                    <button class="btn btn-info" onclick="manualRevealVote(3)">üîì Reveal Vote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        let provider;
        let signer;
        let contract;
        let currentAccount;
        let contractAddress;
        let phaseStartTime = Date.now();
        let timerInterval = null;
        let gasTracking = {
            totalCost: 0,
            totalGasUsed: 0,
            transactions: [],
            avgGasPrice: 0
        };

        const CONTRACT_ABI = [
            "function owner() view returns (address)",
            "function phase() view returns (uint8)",
            "function proposals(uint256) view returns (string name, uint256 voteCount)",
            "function commits(address) view returns (bytes32)",
            "function revealed(address) view returns (bool)",
            "function eligible(address) view returns (bool)",
            "function addEligible(address voter)",
            "function startCommitPhase()",
            "function startRevealPhase()",
            "function endVoting()",
            "function commitVote(bytes32 commit)",
            "function revealVote(uint256 proposalId, string calldata secret)",
            "function getProposals() view returns (string[] memory names, uint256[] memory counts)",
            "function getCurrentPhase() view returns (string memory)"
        ];

        const VOTERS = {
            1: {
                address: '0xFFcf8FDEE72ac11b5c542428B35EEF5769C409f0',
                privateKey: '0x6cbed15c793ce57650b9877cf6fa156fbef513c4e6134f022a85b1ffdd59b2a1',
                secret: 'voter1secret'
            },
            2: {
                address: '0x22d491Bde2303f2f43325b2108D26f1eAbA1e32b',
                privateKey: '0x6370fd033278c143179d81c5526140625662b8daa446c22ee2d73db3707e620c',
                secret: 'voter2secret'
            },
            3: {
                address: '0xE11BA2b4D45Eaed5996Cd0823791E0C93114882d',
                privateKey: '0x646f1ce2fdad0e6deeeb5c7e8e5543bdde65e86029e2fd9fc169899c440a7913',
                secret: 'voter3secret'
            }
        };

        const CANDIDATE_NAMES = ['Candidate A', 'Candidate B', 'Candidate C'];

        // Store manual vote choices
        let manualVoteChoices = {
            1: { proposalId: 0, hasCommitted: false },
            2: { proposalId: 1, hasCommitted: false },
            3: { proposalId: 2, hasCommitted: false }
        };

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyContractAddress() {
            const address = document.getElementById('contractAddress').value;
            if (address) {
                navigator.clipboard.writeText(address);
                showToast('‚úì Contract address copied!', 'success');
            }
        }

        function copyVoterAddress(voterNum) {
            const address = VOTERS[voterNum].address;
            navigator.clipboard.writeText(address);
            showToast(`‚úì Voter ${voterNum} address copied!`, 'success');
        }

        function startPhaseTimer() {
            phaseStartTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - phaseStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('phaseTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        async function updateVoteCounters() {
            try {
                let committed = 0;
                let revealed = 0;
                
                for (let i = 1; i <= 3; i++) {
                    const voter = VOTERS[i];
                    const commitHash = await contract.commits(voter.address);
                    const isRevealed = await contract.revealed(voter.address);
                    
                    if (commitHash !== '0x0000000000000000000000000000000000000000000000000000000000000000') {
                        committed++;
                    }
                    if (isRevealed) {
                        revealed++;
                    }
                }
                
                document.getElementById('committedCount').textContent = committed;
                document.getElementById('revealedCount').textContent = revealed;
                document.getElementById('totalVotes').textContent = revealed;
                
                animateValue('committedCount', committed);
                animateValue('revealedCount', revealed);
                animateValue('totalVotes', revealed);
                
            } catch (error) {
                console.error('Error updating counters:', error);
            }
        }

        function animateValue(id, value) {
            const element = document.getElementById(id);
            element.style.transform = 'scale(1.2)';
            element.style.color = 'var(--success)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.color = 'var(--primary)';
            }, 300);
        }

        function showWinner(winnerName, voteCount) {
            const banner = document.getElementById('winnerBanner');
            const text = document.getElementById('winnerText');
            text.innerHTML = `<strong>${winnerName}</strong> WINS with ${voteCount} vote${voteCount > 1 ? 's' : ''}!`;
            banner.classList.remove('hidden');
            
            triggerConfetti();
        }

        function triggerConfetti() {
            const duration = 3 * 1000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#64B5F6', '#81C784', '#FFB74D', '#E57373']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#64B5F6', '#81C784', '#FFB74D', '#E57373']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            logContainer.classList.remove('hidden');
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function addGasLog(tx, actionName) {
            try {
                const receipt = await tx.wait();
                const gasUsed = receipt.gasUsed;
                const gasPrice = receipt.gasPrice || tx.gasPrice;
                
                // Calculate cost in ETH
                const gasCostWei = gasUsed * gasPrice;
                const gasCostEth = ethers.formatEther(gasCostWei);
                const gasCostGwei = ethers.formatUnits(gasPrice, 'gwei');
                
                // Format for display
                const gasCostEthFormatted = parseFloat(gasCostEth).toFixed(6);
                const gasUsedFormatted = gasUsed.toString();
                const gasPriceFormatted = parseFloat(gasCostGwei).toFixed(2);
                
                // Update gas tracking
                gasTracking.totalCost += parseFloat(gasCostEthFormatted);
                gasTracking.totalGasUsed += parseInt(gasUsedFormatted);
                gasTracking.transactions.push({
                    action: actionName,
                    gasUsed: gasUsedFormatted,
                    gasPrice: gasPriceFormatted,
                    cost: gasCostEthFormatted
                });
                
                // Calculate average gas price
                gasTracking.avgGasPrice = gasTracking.transactions.reduce((sum, tx) => 
                    sum + parseFloat(tx.gasPrice), 0) / gasTracking.transactions.length;
                
                // Update gas analytics display
                updateGasAnalytics();
                
                // Add to regular log
                addLog(`üí∞ ${actionName} | Gas: ${gasUsedFormatted} units | Price: ${gasPriceFormatted} Gwei | Cost: ${gasCostEthFormatted} ETH`, 'warning');
                
                // Add to gas-specific log
                addGasLogEntry(actionName, gasUsedFormatted, gasPriceFormatted, gasCostEthFormatted);
                
                return {
                    gasUsed: gasUsed.toString(),
                    gasPrice: gasPriceFormatted,
                    costEth: gasCostEthFormatted
                };
            } catch (error) {
                console.error('Gas logging error:', error);
                return null;
            }
        }

        function addGasLogEntry(action, gasUsed, gasPrice, cost) {
            const logContainer = document.getElementById('gasLogEntries');
            const card = document.getElementById('gasAnalyticsCard');
            
            // Show the gas analytics card
            card.classList.remove('hidden');
            
            // Clear placeholder text if it exists
            if (logContainer.querySelector('p')) {
                logContainer.innerHTML = '';
            }
            
            const entry = document.createElement('div');
            entry.className = 'gas-log-entry';
            const timestamp = new Date().toLocaleTimeString();
            
            entry.innerHTML = `
                <div class="gas-log-time">${timestamp}</div>
                <div class="gas-log-action">${action}</div>
                <div class="gas-log-details">
                    <span class="gas-detail"><strong>Gas:</strong> ${gasUsed} units</span>
                    <span class="gas-detail"><strong>Price:</strong> ${gasPrice} Gwei</span>
                    <span class="gas-detail"><strong>Cost:</strong> ${cost} ETH</span>
                </div>
            `;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateGasAnalytics() {
            document.getElementById('totalGasCost').textContent = gasTracking.totalCost.toFixed(6);
            document.getElementById('totalGasUsed').textContent = gasTracking.totalGasUsed.toLocaleString();
            document.getElementById('avgGasPrice').textContent = gasTracking.avgGasPrice.toFixed(2);
            document.getElementById('transactionCount').textContent = gasTracking.transactions.length;
            
            // Animate the updated values
            ['totalGasCost', 'totalGasUsed', 'avgGasPrice', 'transactionCount'].forEach(id => {
                const element = document.getElementById(id);
                element.style.transform = 'scale(1.15)';
                element.style.color = 'var(--success)';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = 'var(--primary)';
                }, 400);
            });
        }

        function updateStep(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            if (status === 'active') {
                step.classList.add('active');
                step.classList.remove('completed');
            } else if (status === 'completed') {
                step.classList.remove('active');
                step.classList.add('completed');
            }
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showAlert('danger', '‚ùå MetaMask not found! Please install MetaMask.');
                    showToast('‚ùå MetaMask not found! Please install MetaMask.', 'error');
                    return;
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = await provider.getSigner();
                currentAccount = await signer.getAddress();

                document.getElementById('accountAddress').textContent = 
                    currentAccount.substring(0, 10) + '...' + currentAccount.substring(currentAccount.length - 8);
                document.getElementById('statusBar').classList.remove('hidden');
                document.getElementById('networkIndicator').classList.remove('hidden');
                
                showAlert('success', `‚úì Connected: ${currentAccount.substring(0, 10)}...`);
                showToast(`‚úì Connected: ${currentAccount.substring(0, 10)}...`, 'success');
            } catch (error) {
                console.error(error);
                showAlert('danger', '‚ùå Failed to connect: ' + error.message);
                showToast('‚ùå Failed to connect: ' + error.message, 'error');
            }
        }

        async function loadContract() {
            try {
                let addr = document.getElementById('contractAddress').value.trim().replace(/\s+/g, '');
                
                if (!addr || addr.length < 40) {
                    showToast('‚ö†Ô∏è Please enter a valid contract address', 'warning');
                    return;
                }

                if (!addr.startsWith('0x')) addr = '0x' + addr;

                if (!signer) {
                    showToast('‚ö†Ô∏è Please connect MetaMask first', 'warning');
                    return;
                }

                addr = ethers.getAddress(addr);
                contractAddress = addr;
                contract = new ethers.Contract(addr, CONTRACT_ABI, signer);
                
                const code = await provider.getCode(addr);
                if (code === '0x') {
                    showToast('‚ùå No contract found at this address', 'error');
                    return;
                }
                
                document.getElementById('loadedContract').textContent = 
                    addr.substring(0, 10) + '...' + addr.substring(addr.length - 8);

                const ownerAddress = await contract.owner();
                const isOwner = currentAccount.toLowerCase() === ownerAddress.toLowerCase();
                
                document.getElementById('automationCard').classList.remove('hidden');
                
                if (isOwner) {
                    document.getElementById('ownerCard').classList.remove('hidden');
                }

                await updatePhaseDisplay();
                await refreshProposals();
                await updateVoteCounters();
                startPhaseTimer();
                
                showToast('‚úì Contract loaded! Choose votes and click automation button.', 'success');
            } catch (error) {
                console.error(error);
                showToast('‚ùå Failed to load contract: ' + error.message, 'error');
            }
        }

        async function runSmartAutomation() {
            const btn = document.getElementById('automateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Running automation...';
            
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('logContainer').innerHTML = '';
            
            try {
                const ganacheProvider = new ethers.JsonRpcProvider('http://127.0.0.1:8545');
                
                // Get user's vote choices
                const voter1Choice = parseInt(document.getElementById('voter1Choice').value);
                const voter2Choice = parseInt(document.getElementById('voter2Choice').value);
                const voter3Choice = parseInt(document.getElementById('voter3Choice').value);
                
                addLog(`üìã Vote Choices: Voter1‚Üí${CANDIDATE_NAMES[voter1Choice]}, Voter2‚Üí${CANDIDATE_NAMES[voter2Choice]}, Voter3‚Üí${CANDIDATE_NAMES[voter3Choice]}`, 'info');
                
                // Step 1: Setup
                updateStep(1, 'active');
                addLog('üöÄ Starting smart automation...', 'info');
                startPhaseTimer();
                
                const currentPhase = await contract.getCurrentPhase();
                addLog(`Current phase: ${currentPhase}`, 'info');
                
                if (currentPhase === 'Created') {
                    addLog('Adding 3 eligible voters...', 'info');
                    
                    for (let i = 1; i <= 3; i++) {
                        const voter = VOTERS[i];
                        const isEligible = await contract.eligible(voter.address);
                        
                        if (!isEligible) {
                            addLog(`Adding Voter ${i}...`, 'info');
                            const tx = await contract.addEligible(voter.address);
                            await addGasLog(tx, `Add Voter ${i}`);
                            addLog(`‚úì Voter ${i} added`, 'success');
                        } else {
                            addLog(`‚úì Voter ${i} already eligible`, 'info');
                        }
                        await new Promise(r => setTimeout(r, 500));
                    }
                    
                    addLog('Starting commit phase...', 'info');
                    const commitTx = await contract.startCommitPhase();
                    await addGasLog(commitTx, 'Start Commit Phase');
                    await updatePhaseDisplay();
                    addLog('‚úì Commit phase started', 'success');
                    startPhaseTimer();
                } else if (currentPhase !== 'Commit Phase') {
                    throw new Error(`Wrong phase: ${currentPhase}. Need Created or Commit Phase.`);
                }
                
                updateStep(1, 'completed');
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 2: Commit votes with user's choices
                updateStep(2, 'active');
                addLog('All voters committing their votes...', 'info');
                
                const choices = [voter1Choice, voter2Choice, voter3Choice];
                
                for (let i = 1; i <= 3; i++) {
                    const voter = VOTERS[i];
                    const proposalId = choices[i - 1];
                    const candidateName = CANDIDATE_NAMES[proposalId];
                    
                    addLog(`Voter ${i} committing vote for ${candidateName}...`, 'info');
                    
                    const wallet = new ethers.Wallet(voter.privateKey, ganacheProvider);
                    const voterContract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);
                    
                    const commitHash = ethers.keccak256(
                        ethers.solidityPacked(['uint256', 'string'], [proposalId, voter.secret])
                    );
                    
                    const tx = await voterContract.commitVote(commitHash);
                    await addGasLog(tx, `Voter ${i} Commit Vote (${candidateName})`);
                    addLog(`‚úì Voter ${i} committed (${candidateName})`, 'success');
                    await updateVoteCounters();
                    await new Promise(r => setTimeout(r, 800));
                }
                
                updateStep(2, 'completed');
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 3: Start reveal
                updateStep(3, 'active');
                addLog('Starting reveal phase...', 'info');
                
                const revealTx = await contract.startRevealPhase();
                await addGasLog(revealTx, 'Start Reveal Phase');
                await updatePhaseDisplay();
                addLog('‚úì Reveal phase started', 'success');
                startPhaseTimer();
                
                updateStep(3, 'completed');
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 4: Reveal votes
                updateStep(4, 'active');
                addLog('All voters revealing their votes...', 'info');
                
                for (let i = 1; i <= 3; i++) {
                    const voter = VOTERS[i];
                    const proposalId = choices[i - 1];
                    const candidateName = CANDIDATE_NAMES[proposalId];
                    
                    addLog(`Voter ${i} revealing vote for ${candidateName}...`, 'info');
                    
                    const wallet = new ethers.Wallet(voter.privateKey, ganacheProvider);
                    const voterContract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);
                    
                    const tx = await voterContract.revealVote(proposalId, voter.secret);
                    await addGasLog(tx, `Voter ${i} Reveal Vote (${candidateName})`);
                    addLog(`‚úì Voter ${i} revealed (${candidateName})`, 'success');
                    await updateVoteCounters();
                    await new Promise(r => setTimeout(r, 800));
                }
                
                updateStep(4, 'completed');
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 5: Done
                updateStep(5, 'active');
                await refreshProposals();
                updateStep(5, 'completed');
                
                addLog('üéâ AUTOMATION COMPLETE!', 'success');
                showToast('üéâ Voting complete! Check results below.', 'success');
                btn.textContent = '‚úì Automation Complete!';
                
                await new Promise(r => setTimeout(r, 1000));
                await determineWinner();
                
            } catch (error) {
                console.error(error);
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showToast('‚ùå Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'üéØ START VOTING WITH YOUR CHOICES';
            }
        }

        async function manualCommitVote(voterNum) {
            try {
                const proposalId = parseInt(document.getElementById(`manualVoter${voterNum}Choice`).value);
                const candidateName = CANDIDATE_NAMES[proposalId];
                
                showToast(`‚è≥ Voter ${voterNum} committing vote for ${candidateName}...`, 'info');

                const voter = VOTERS[voterNum];
                const ganacheProvider = new ethers.JsonRpcProvider('http://127.0.0.1:8545');
                const wallet = new ethers.Wallet(voter.privateKey, ganacheProvider);
                const voterContract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);

                const commitHash = ethers.keccak256(
                    ethers.solidityPacked(['uint256', 'string'], [proposalId, voter.secret])
                );
                
                const tx = await voterContract.commitVote(commitHash);
                await addGasLog(tx, `Manual: Voter ${voterNum} Commit (${candidateName})`);
                
                manualVoteChoices[voterNum] = { proposalId, hasCommitted: true };
                
                showToast(`‚úì Voter ${voterNum} committed vote for ${candidateName}!`, 'success');
                await updateVoteCounters();
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function manualRevealVote(voterNum) {
            try {
                if (!manualVoteChoices[voterNum].hasCommitted) {
                    showToast(`‚ö†Ô∏è Voter ${voterNum} must commit first!`, 'warning');
                    return;
                }
                
                const proposalId = manualVoteChoices[voterNum].proposalId;
                const candidateName = CANDIDATE_NAMES[proposalId];
                
                showToast(`‚è≥ Voter ${voterNum} revealing vote for ${candidateName}...`, 'info');

                const voter = VOTERS[voterNum];
                const ganacheProvider = new ethers.JsonRpcProvider('http://127.0.0.1:8545');
                const wallet = new ethers.Wallet(voter.privateKey, ganacheProvider);
                const voterContract = new ethers.Contract(contractAddress, CONTRACT_ABI, wallet);

                const tx = await voterContract.revealVote(proposalId, voter.secret);
                await addGasLog(tx, `Manual: Voter ${voterNum} Reveal (${candidateName})`);
                
                showToast(`‚úì Voter ${voterNum} revealed vote for ${candidateName}!`, 'success');
                await updateVoteCounters();
                
                setTimeout(async () => {
                    await refreshProposals();
                    await determineWinner();
                }, 2000);
            } catch (error) {
                console.error(error);
                showToast(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function updatePhaseDisplay() {
            try {
                const phaseName = await contract.getCurrentPhase();
                const phaseSpan = document.getElementById('currentPhase');
                
                let phaseClass = 'phase-created';
                if (phaseName === 'Commit Phase') phaseClass = 'phase-commit';
                else if (phaseName === 'Reveal Phase') phaseClass = 'phase-reveal';
                else if (phaseName === 'Ended') phaseClass = 'phase-ended';
                
                phaseSpan.innerHTML = `<span class="phase-badge ${phaseClass}">${phaseName}</span>`;
            } catch (error) {
                console.error(error);
            }
        }

        async function refreshProposals() {
            try {
                const [names, counts] = await contract.getProposals();
                const container = document.getElementById('proposalsContainer');
                const chartContainer = document.getElementById('barChart');
                const resultsChart = document.getElementById('resultsChart');
                
                container.innerHTML = '';
                chartContainer.innerHTML = '';

                let totalVotes = 0;
                counts.forEach(count => totalVotes += Number(count));

                // Show chart if there are votes
                if (totalVotes > 0) {
                    resultsChart.classList.remove('hidden');
                }

                // Find max votes for chart scaling
                const maxVotes = Math.max(...counts.map(c => Number(c)));

                for (let i = 0; i < names.length; i++) {
                    const voteCount = Number(counts[i]);
                    const percentage = totalVotes > 0 ? ((voteCount / totalVotes) * 100).toFixed(1) : 0;
                    const barWidth = maxVotes > 0 ? (voteCount / maxVotes) * 100 : 0;
                    
                    // Proposal cards
                    const div = document.createElement('div');
                    div.className = 'proposal-card';
                    div.innerHTML = `
                        <h3>${names[i]}</h3>
                        <div class="votes">${voteCount}</div>
                        <div class="vote-label">votes (${percentage}%)</div>
                    `;
                    container.appendChild(div);

                    // Bar chart
                    if (totalVotes > 0) {
                        const barItem = document.createElement('div');
                        barItem.className = 'bar-item';
                        barItem.innerHTML = `
                            <div class="bar-label">${names[i]}</div>
                            <div class="bar-wrapper">
                                <div class="bar-fill" style="width: ${barWidth}%">
                                    <span class="bar-value">${voteCount} vote${voteCount !== 1 ? 's' : ''} (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                        chartContainer.appendChild(barItem);
                    }
                }
                await updatePhaseDisplay();
            } catch (error) {
                console.error(error);
            }
        }

        async function determineWinner() {
            try {
                const [names, counts] = await contract.getProposals();
                let maxVotes = 0;
                let winnerName = '';
                
                for (let i = 0; i < counts.length; i++) {
                    const voteCount = Number(counts[i]);
                    if (voteCount > maxVotes) {
                        maxVotes = voteCount;
                        winnerName = names[i];
                    }
                }
                
                if (maxVotes > 0) {
                    showWinner(winnerName, maxVotes);
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function startCommitPhase() {
            try {
                showToast('‚è≥ Starting commit phase...', 'info');
                const tx = await contract.startCommitPhase();
                await addGasLog(tx, 'Manual: Start Commit Phase');
                await updatePhaseDisplay();
                startPhaseTimer();
                showToast('‚úì Commit phase started!', 'success');
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function startRevealPhase() {
            try {
                showToast('‚è≥ Starting reveal phase...', 'info');
                const tx = await contract.startRevealPhase();
                await addGasLog(tx, 'Manual: Start Reveal Phase');
                await updatePhaseDisplay();
                startPhaseTimer();
                showToast('‚úì Reveal phase started!', 'success');
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function endVoting() {
            try {
                showToast('‚è≥ Ending voting...', 'info');
                const tx = await contract.endVoting();
                await addGasLog(tx, 'Manual: End Voting');
                await updatePhaseDisplay();
                await refreshProposals();
                showToast('üèÅ Voting ended!', 'success');
                
                triggerConfetti();
                await determineWinner();
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function addEligibleVoter() {
            try {
                const address = document.getElementById('eligibleAddress').value.trim();
                if (!address) {
                    showToast('‚ö†Ô∏è Please enter an address', 'warning');
                    return;
                }
                showToast('‚è≥ Adding voter...', 'info');
                const tx = await contract.addEligible(address);
                await addGasLog(tx, 'Manual: Add Eligible Voter');
                showToast('‚úì Voter added successfully!', 'success');
                document.getElementById('eligibleAddress').value = '';
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        function showAlert(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
        }

        // Auto-refresh results every 15 seconds
        setInterval(() => {
            if (contract) {
                refreshProposals();
                updateVoteCounters();
            }
        }, 15000);
    </script>
</body>
</html>
